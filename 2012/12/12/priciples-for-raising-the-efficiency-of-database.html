<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[ Tips ] 提高資料庫效率的原則 - 從外而內</title>
  <meta name="description" content="上個月簡直是被追殺般在工作，喘一口氣的時間把這段日子的工作和阻礙稍作整理。">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://carolhsu.github.io/2012/12/12/priciples-for-raising-the-efficiency-of-database.html">
  <link rel="alternate" type="application/rss+xml" title="shesee's 不定期更新" href="http://carolhsu.github.io/feed.xml" />
</head>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">shesee's 不定期更新</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>

    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">[ Tips ] 提高資料庫效率的原則 - 從外而內</h1>
    <p class="post-meta">Dec 12, 2012</p>
  </header>

  <article class="post-content">
    <p>上個月簡直是被追殺般在工作，喘一口氣的時間把這段日子的工作和阻礙稍作整理。</p>

<p>由於資訊系統經過經年累月的開發與使用，各個單位及不同工程師對於資料處理的偏好方式不同，加上科技進展日新月異，自然導致一個系統的資料儲存與使用方式最後千奇百怪，以交通控制系統為例，資料庫到後來會成長肥大到幾乎無法維護，若要讓資訊系統發揮最大效用，從一開始便需要有專業的架構師設計出完整的資料庫架構，提供整合且方便維護的資訊系統。</p>

<!-- more -->

<p>資料庫最常最大量的使用通常在一般公司行號是倉儲系統，其難處在於：</p>

<ul>
  <li>難以掌握所有資料庫系統 </li>
</ul>

<p>用來儲存資料的會是一個超大型關聯式資料庫，例如SQL Server，而需要轉進的各個線上交易系統卻可能多所不同，程式設計師要同時瞭解各種資料存取機制並不容易。</p>

<ul>
  <li>格式紊亂 </li>
</ul>

<p>凡是要轉進資料庫的資料應先求得意義和格式的一致，在不同的系統中，可能人事資料以「男」「女」來標示性別，但是客戶資料就使用「0」「1」，甚至「T」「F」，完全以當時的系統開發人員的喜好決定，無法預測也增加整合困難度，或是差不多的資料在table A是五欄，table B是七欄，種種語意、格式、資料正確性等諸多問題會增加大量的開發阻礙。</p>

<ul>
  <li>週期性的整合工作</li>
</ul>

<p>以開發交控系統為例，其複雜度絕不下於倉儲系統，然而過往的開發多是需要某個新功能時，就新建一個table，並不曾考慮到統合性資料整理的問題，一旦功能龐大系統肥起來之後，雜亂無章的各種資訊不但難以整理並且很多都互相重複，記憶體和搜尋時間是資料庫的成本，隨意耗費之下系統運作效率極低，且交控系統應是時時刻刻更新大量資料的系統，更是需要重視成本耗費的問題，然而這樣的問題往往在一開始開發時隨著開發進度越趨嚴重，究其根本，是因為資料庫的架構不佳導致病入膏肓。</p>

<p>資料庫不同於程式開發，是另一個很專業的領域，或許程式人才可以粗淺的操作去建立最陽春的資料庫，也可以動，然而這樣的方式若是要開發龐大複雜的系統就無異於飲鴆止渴。</p>

<p>所以提高資料庫的效率應該要從哪裡著手？遵循「從外到內」的順序來提高效能 — 網路環境、機器配置、資料庫、資料數據。</p>

<h2 id="網路環境">網路環境</h2>

<p>碰到資料庫反應速度比較慢時，首先想到的是是否是網路環境所造成的。而不是一開始就想著如何去提高資料庫的性能。這是很多工程師的盲點。因為當網路環境惡劣時，就算再怎麼去改善資料庫性能，也是沒用的。</p>

<h2 id="機器配置">機器配置</h2>

<p>這裡指的配置，主要是講資料庫機器的硬體配置以及周邊配套。雖然說提高資料庫的硬體配置需要付出一定的代價。但是這往往是一個比較簡便的方法。比起優化SQL語句來說，其要簡單的多。
例如可以通過增加硬碟的數量來改善資料庫的性能。在實際工作中，硬碟輸入輸出瓶頸經常被工程師所忽視。其實，查詢數比較多的時候，硬碟輸入輸出往往是資料庫性能的一個主要瓶頸之一。此時，若可以增加幾個硬碟，通過磁碟陣列來分散磁碟的壓力，就是提高資料庫性能的一個簡單捷徑。例如增加機器的記憶體或者CPU。當工程師發現資料庫性能的不理想是由記憶體或者CPU所造成的，此時，任何的改善資料庫機器本身的措施都沒有用。所以，有些資料庫管理專家，把改善機器配置當作資料庫性能調整的一個先決條件。</p>

<p>解決部署在同一個資料庫機器上的資源爭用問題。雖然設計原則強調，要為資料庫專門部署一個機器。但是，不少企業為了降低成本，往往把資料庫機器跟應用機器放在同一個機器中。這就會導致不同機器之間的資源爭用問題。如把文件機器跟數據機器部署在同一個機器中，當對文件機器進行備份時，資料庫性能就會有明顯的下降。所以，在資料庫性能發現週期性的變化時，就要考慮是否因為機器上不同應用對資源的爭奪所造成的。</p>

<h2 id="資料庫">資料庫</h2>

<p>當通過改善網路環境或者提高機器配置，都無法達到改善資料庫性能的目的時，接下去就需要考量資料庫本身了。首先就需要考慮資料庫的架構。
一方面，要考慮資料庫的連接模式。 SQL server資料庫提供了很多的資料庫模式，不同的資料庫連接模式對應不同的應用程式。若工程師能夠熟悉企業自身的應用程式，並且選擇合適的連接方法，這往往能夠達到改善資料庫性能的目的。
其次，合理配置資料庫機器的相關作業。例如出於安全的需要，工程師往往需要對資料庫進行備份。那麼，備份的作業放在什麼時候合適呢?當然，放在夜晚，夜深人靜的時候，對資料庫進行備份最好。另外，對於大型資料庫，每天都進行完全備份將會是一件相當累人的事情。雖然累的不是人，可是資料庫機器也會吃不消。差異備份跟完全備份結合將是改善資料庫性能的一個不錯的策略。</p>

<h2 id="資料數據">資料數據</h2>

<p>處理過以上三個層面後，資料庫性能還不能夠得到大幅度改善的話，則就需要考慮是否能夠調整資料數據來完成我們的目的。雖然調整資料數據往往可以提到不錯的效果，但是，往往會對資料庫產生比較大的影響。所以，一般不建議一開始就通過調整資料數據來達到改善資料庫性能的目的。</p>

<p>資料數據有table、view、index、keyword等等。我們也可以通過對這些數據進行調整以實現改善資料庫性能的目標。如在view設計時，盡量把其顯示的內容縮小，寧可多增加view。如出貨明細表。銷售人員可能希望看到產品編號、產品中英文描述、產品名字、出貨日期、客戶編號、客戶名字等等。但是，對於財務來說，可能就不需要這麼多的資訊。他們只需要產品編號、客戶編號、出貨日期等等少量的資訊即可。所以，能可浪費一點code的空間，設計兩張view，對應不同部門的需求。如此，財務部門在查詢數據時，不會為不必要的數據浪費寶貴的資源。</p>

<p>也可以通過合理設置index​​來提高資料庫的性能。index對於提高數據的查詢效率，有著非常好的效果。對一些需要重複查詢的數據、或者數據修改不怎麼多的table設置index，是一個不錯的選擇。另外，要慎用預存程序。雖然說預存程序可以實現很多需求。但是，在萬不得已的情況下，不要使用預存程序。而利用前台的應用程式來實現需求。這主要是因為在通常情況下，前台應用程序的執行效率往往比後台資料庫預存程序要高的多。</p>

<h2 id="最後一招--sql-syntax">最後一招 — SQL syntax</h2>

<p>若以上各個層面都努力過，但是還不滿足其效果的話，則還有最後一招。通過對SQL指令進行優化，也可以達到改善資料庫性能的目的。雖然說SQL Server自身就帶有一個SQL語句優化器。他會對用戶的SQL語句進行調整、優化，以達到比較好的執行效果。但是這個最多只能夠優化一些粗略的層面。或者說，80%的優化仍然需要工程師的配合。要工程師跟SQL優化器進行配合，才能有明顯的作用。</p>

<p>使用MSSQL時，避免直接使用GUI來更改資料庫，因為其中使用的SQL語法有相當程度的stupid，直接下SQL語法是比較好的習慣，也可以同時留下更改資料庫的蹤跡。</p>

<h2 id="總結">總結</h2>

<p>資料庫設計其實是一門比想像中更複雜的專業，需要專業的人才在系統工程專案一開始時就針對整個規格，甚或是往後或許會擴增的規格，進行詳細的架構設計。交通同時也是截然不同的專業，目前國內或許並沒有精通交通知識及資料庫的人才，這方面需要所有團隊成員在進行專案同時詳實紀錄累積過往的知識經驗。就像是開一家麥當勞，為什麼每一個負責炸薯條的工讀生一旦來工作了就自然會炸薯條，
並不是他們原本就會炸薯條，而是已經有人整理出了如何炸薯條的SOP，例如溫度多少，時間多少，一盒薯條大概有多少。這就是為什麼讓一個完全沒有炸過薯條的人一旦站到炸薯條的機器面前也變得會了，並且全部的麥當勞炸出來的薯條品質都不會差異過大，我一直認為「整理知識」對團隊而言是需要且必要的過程。</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">shesee's 不定期更新</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>shesee's 不定期更新</li>
          <li><a href="mailto:sheseee@gmail.com">sheseee@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/carolhsu">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">carolhsu</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/sheseee">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">sheseee</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">大多數內容是 Ruby on Rails，心血來潮天時地利人和才會更新，簡直令人髮指。
</p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
